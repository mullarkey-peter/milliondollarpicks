This file is a merged representation of the entire codebase, combining all repository files into a single document.
Generated by Repomix on: 2025-02-28T00:54:06.401Z

================================================================
File Summary
================================================================

Purpose:
--------
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.

File Format:
------------
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Multiple file entries, each consisting of:
  a. A separator line (================)
  b. The file path (File: path/to/file)
  c. Another separator line
  d. The full contents of the file
  e. A blank line

Usage Guidelines:
-----------------
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.

- Pay special attention to the Repository Instruction. These contain important context and guidelines specific to this project.

Notes:
------
- Some files may have been excluded based on .gitignore rules and Repomix's
  configuration.
- Binary files are not included in this packed representation. Please refer to
  the Repository Structure section for a complete list of file paths, including
  binary files.
- Code comments have been removed.

Additional Info:
----------------

================================================================
Directory Structure
================================================================
.gitattributes
.gitignore
build.gradle
compose.yaml
Diagrams/MicroserviceArchitecture.puml
gradle/wrapper/gradle-wrapper.properties
README.md
repomix-instructions.md
settings.gradle
src/main/java/com/glizzy/milliondollarpicks/MillionDollarPicksApplication.java
src/main/resources/application.properties
user-service/.gitattributes
user-service/.gitignore
user-service/build.gradle
user-service/Dockerfile
user-service/gradle/wrapper/gradle-wrapper.properties
user-service/gradlew
user-service/gradlew.bat
user-service/settings.gradle
user-service/src/main/java/com/glizzy/milliondollarpicks/userservice/config/JwtProperties.java
user-service/src/main/java/com/glizzy/milliondollarpicks/userservice/config/PasswordEncoderConfig.java
user-service/src/main/java/com/glizzy/milliondollarpicks/userservice/config/R2dbcConfig.java
user-service/src/main/java/com/glizzy/milliondollarpicks/userservice/config/SecurityConfig.java
user-service/src/main/java/com/glizzy/milliondollarpicks/userservice/dto/UserDto.java
user-service/src/main/java/com/glizzy/milliondollarpicks/userservice/entity/User.java
user-service/src/main/java/com/glizzy/milliondollarpicks/userservice/exception/DuplicateUserException.java
user-service/src/main/java/com/glizzy/milliondollarpicks/userservice/exception/ErrorResponse.java
user-service/src/main/java/com/glizzy/milliondollarpicks/userservice/exception/GlobalExceptionHandler.java
user-service/src/main/java/com/glizzy/milliondollarpicks/userservice/exception/InvalidCredentialsException.java
user-service/src/main/java/com/glizzy/milliondollarpicks/userservice/exception/JwtAuthenticationException.java
user-service/src/main/java/com/glizzy/milliondollarpicks/userservice/exception/UserNotFoundException.java
user-service/src/main/java/com/glizzy/milliondollarpicks/userservice/graphql/ScalarConfig.java
user-service/src/main/java/com/glizzy/milliondollarpicks/userservice/graphql/UserResolver.java
user-service/src/main/java/com/glizzy/milliondollarpicks/userservice/mapper/UserMapper.java
user-service/src/main/java/com/glizzy/milliondollarpicks/userservice/repository/UserRepository.java
user-service/src/main/java/com/glizzy/milliondollarpicks/userservice/security/AuthenticationManager.java
user-service/src/main/java/com/glizzy/milliondollarpicks/userservice/security/JwtAuthenticationFilter.java
user-service/src/main/java/com/glizzy/milliondollarpicks/userservice/security/JwtTokenProvider.java
user-service/src/main/java/com/glizzy/milliondollarpicks/userservice/service/UserService.java
user-service/src/main/java/com/glizzy/milliondollarpicks/userservice/service/UserServiceImpl.java
user-service/src/main/java/com/glizzy/milliondollarpicks/userservice/UserServiceApplication.java
user-service/src/main/resources/application-docker.yml
user-service/src/main/resources/application.yml
user-service/src/main/resources/db/migration/V1__init_user_schema.sql
user-service/src/main/resources/schema/schema.graphqls

================================================================
Files
================================================================

================
File: .gitattributes
================
/gradlew text eol=lf
*.bat text eol=crlf
*.jar binary

================
File: .gitignore
================
HELP.md
.gradle
build/
!gradle/wrapper/gradle-wrapper.jar
!**/src/main/**/build/
!**/src/test/**/build/

### STS ###
.apt_generated
.classpath
.factorypath
.project
.settings
.springBeans
.sts4-cache
bin/
!**/src/main/**/bin/
!**/src/test/**/bin/

### IntelliJ IDEA ###
.idea
*.iws
*.iml
*.ipr
out/
!**/src/main/**/out/
!**/src/test/**/out/

### NetBeans ###
/nbproject/private/
/nbbuild/
/dist/
/nbdist/
/.nb-gradle/

### VS Code ###
.vscode/

================
File: build.gradle
================
plugins {
    id 'java'
    id 'org.springframework.boot' version '3.2.3'
    id 'io.spring.dependency-management' version '1.1.4'
}

repositories {
    mavenCentral()
    maven { url "https://repo.spring.io/milestone" }
    maven { url "https://repo.spring.io/release" }
}

dependencies {
    implementation 'org.springframework.boot:spring-boot-starter'
    developmentOnly 'org.springframework.boot:spring-boot-docker-compose'
}

subprojects {
    apply plugin: 'java'
    apply plugin: 'org.springframework.boot'
    apply plugin: 'io.spring.dependency-management'

    group = 'com.glizzy'
    version = '0.0.1-SNAPSHOT'

    java {
        toolchain {
            languageVersion = JavaLanguageVersion.of(17)
        }
    }

    configurations {
        compileOnly {
            extendsFrom annotationProcessor
        }
    }

    // Common dependencies that might be shared across services
    dependencies {
        compileOnly 'org.projectlombok:lombok'
        annotationProcessor 'org.projectlombok:lombok'
        developmentOnly 'org.springframework.boot:spring-boot-devtools'
        developmentOnly 'org.springframework.boot:spring-boot-docker-compose'
    }

    test {
        useJUnitPlatform()
    }
}

================
File: compose.yaml
================
services:
  postgres:
    image: postgres:15-alpine
    environment:
      - POSTGRES_DB=userdb
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
  user-service:
    build:
      context: ./user-service
      dockerfile: Dockerfile
    container_name: user-service
    ports:
      - "8081:8080"
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - SPRING_R2DBC_URL=r2dbc:postgresql://postgres:5432/userdb
      - SPRING_R2DBC_USERNAME=postgres
      - SPRING_R2DBC_PASSWORD=postgres
      - SPRING_FLYWAY_URL=jdbc:postgresql://postgres:5432/userdb
      - SPRING_FLYWAY_USER=postgres
      - SPRING_FLYWAY_PASSWORD=postgres
      - JWT_SECRET=a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6q7r8s9t0u1v2w3x4y5z6a7b8c9d0
    depends_on:
      postgres:
        condition: service_healthy
volumes:
  postgres_data:
    driver: local

================
File: Diagrams/MicroserviceArchitecture.puml
================
@startuml

' Define the diagram layout
top to bottom direction
skinparam componentStyle rectangle

' Define node types
skinparam rectangle {
  BackgroundColor<<Client>> LightBlue
  BorderColor<<Client>> DarkBlue
}

skinparam rectangle {
  BackgroundColor<<Service>> LightGreen
  BorderColor<<Service>> DarkGreen
}

skinparam database {
  BackgroundColor LightYellow
  BorderColor DarkOrange
}

' Client Applications
rectangle "Mobile App" as MobileApp <<Client>>
rectangle "Web App" as WebApp <<Client>>
rectangle "3rd Party App" as ThirdPartyApp <<Client>>

' API Gateway
rectangle "GraphQL Federation Gateway" as Gateway

' Internal Services
rectangle "User Service\n(Spring WebFlux + DGS)" as UserService <<Service>>
rectangle "Event Service\n(Spring WebFlux + DGS)" as EventService <<Service>>
rectangle "Prediction Service\n(Spring WebFlux + DGS)" as PredictionService <<Service>>
rectangle "Betting Service\n(Spring WebFlux + DGS)" as BettingService <<Service>>
rectangle "Notification Service\n(Spring WebFlux + DGS)" as NotificationService <<Service>>
rectangle "Reporting Service\n(Spring WebFlux + DGS)" as ReportingService <<Service>>

' Data Storage
database "User DB" as UserDB
database "Event DB" as EventDB
database "Prediction DB" as PredictionDB
database "Betting DB" as BettingDB
database "Notification DB" as NotificationDB
database "Reporting DB" as ReportingDB

' Message Broker
rectangle "Apache Kafka" as Kafka

' External API connections (GraphQL)
MobileApp -down-> Gateway : GraphQL
WebApp -down-> Gateway : GraphQL
ThirdPartyApp -down-> Gateway : GraphQL

Gateway -down-> UserService : GraphQL\nFederation
Gateway -down-> EventService : GraphQL\nFederation
Gateway -down-> PredictionService : GraphQL\nFederation
Gateway -down-> BettingService : GraphQL\nFederation
Gateway -down-> NotificationService : GraphQL\nFederation
Gateway -down-> ReportingService : GraphQL\nFederation

' Service to DB connections
UserService -down-> UserDB : R2DBC
EventService -down-> EventDB : R2DBC
PredictionService -down-> PredictionDB : R2DBC
BettingService -down-> BettingDB : R2DBC
NotificationService -down-> NotificationDB : Reactive MongoDB
ReportingService -down-> ReportingDB : R2DBC

' Kafka connections
UserService -down-> Kafka : Pub/Sub
EventService -down-> Kafka : Pub/Sub
PredictionService -down-> Kafka : Pub/Sub
BettingService -down-> Kafka : Pub/Sub
Kafka -up-> NotificationService : Consume
Kafka -up-> ReportingService : Consume

' gRPC connections (using dashed lines)
PredictionService ...> EventService : gRPC
BettingService ...> PredictionService : gRPC
BettingService ...> UserService : gRPC
NotificationService ...> UserService : gRPC
ReportingService ...> UserService : gRPC
ReportingService ...> EventService : gRPC
ReportingService ...> PredictionService : gRPC
ReportingService ...> BettingService : gRPC

@enduml

================
File: gradle/wrapper/gradle-wrapper.properties
================
distributionBase=GRADLE_USER_HOME
distributionPath=wrapper/dists
distributionUrl=https\://services.gradle.org/distributions/gradle-8.12.1-bin.zip
networkTimeout=10000
validateDistributionUrl=true
zipStoreBase=GRADLE_USER_HOME
zipStorePath=wrapper/dists

================
File: README.md
================
# Project Title

Million Dollar Picks is an application to allow users to compete using fake money based off of Bill Simmons weekly segment on his podcast.


## Acknowledgements

 - [Awesome Readme Templates](https://awesomeopensource.com/project/elangosundar/awesome-README-templates)
 - [Awesome README](https://github.com/matiassingers/awesome-readme)
 - [How to write a Good readme](https://bulldogjob.com/news/449-how-to-write-a-good-readme-for-your-github-project)


## API Reference

#### Get all items

```http
  GET /api/items
```

| Parameter | Type     | Description                |
| :-------- | :------- | :------------------------- |
| `api_key` | `string` | **Required**. Your API key |

#### Get item

```http
  GET /api/items/${id}
```

| Parameter | Type     | Description                       |
| :-------- | :------- | :-------------------------------- |
| `id`      | `string` | **Required**. Id of item to fetch |

#### add(num1, num2)

Takes two numbers and returns the sum.


## Authors

- [@mullarkey-peter](https://www.github.com/octokatherine)


## Deployment

To deploy this project run

```bash
  npm run deploy
```


## Environment Variables

To run this project, you will need to add the following environment variables to your .env file

`API_KEY`

`ANOTHER_API_KEY`


## Documentation

[Documentation](https://linktodocumentation)


## Run Locally

Clone the project

```bash
  git clone https://link-to-project
```

Go to the project directory

```bash
  cd my-project
```

Install dependencies

```bash
  npm install
```

Start the server

```bash
  npm run start
```


## Demo

Insert gif or link to demo

================
File: repomix-instructions.md
================
{
    "output": {
        "instructionFilePath": "repomix-instruction.md",
        "removeComments": true
    }
}

================
File: settings.gradle
================
// settings.gradle
rootProject.name = 'million-dollar-picks'

include 'user-service'

================
File: src/main/java/com/glizzy/milliondollarpicks/MillionDollarPicksApplication.java
================
package com.glizzy.milliondollarpicks;
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.boot.context.properties.EnableConfigurationProperties;
@SpringBootApplication
@EnableConfigurationProperties
public class MillionDollarPicksApplication {
    public static void main(String[] args) {
        SpringApplication.run(MillionDollarPicksApplication.class, args);
    }
}

================
File: src/main/resources/application.properties
================
spring.application.name=MillionDollarPicks

server:
  port: 8081

logging:
  level:
    org.springframework.r2dbc: DEBUG
    com.milliondollarpicks: DEBUG

================
File: user-service/.gitattributes
================
/gradlew text eol=lf
*.bat text eol=crlf
*.jar binary

================
File: user-service/.gitignore
================
HELP.md
.gradle
build/
!gradle/wrapper/gradle-wrapper.jar
!**/src/main/**/build/
!**/src/test/**/build/

### STS ###
.apt_generated
.classpath
.factorypath
.project
.settings
.springBeans
.sts4-cache
bin/
!**/src/main/**/bin/
!**/src/test/**/bin/

### IntelliJ IDEA ###
.idea
*.iws
*.iml
*.ipr
out/
!**/src/main/**/out/
!**/src/test/**/out/

### NetBeans ###
/nbproject/private/
/nbbuild/
/dist/
/nbdist/
/.nb-gradle/

### VS Code ###
.vscode/

================
File: user-service/build.gradle
================
plugins {
    id 'java'
    id 'org.springframework.boot' version '3.2.3'
    id 'io.spring.dependency-management' version '1.1.4'
}

group = 'com.glizzy'
version = '0.0.1-SNAPSHOT'

java {
    sourceCompatibility = '17'
}

ext {
    set('springCloudVersion', "2023.0.0")
    set('jjwtVersion', "0.12.5")
    set('dgsVersion', "8.4.0")
}

configurations {
    compileOnly {
        extendsFrom annotationProcessor
    }
}

repositories {
    mavenCentral()
    maven { url "https://repo.spring.io/milestone" }
    maven { url "https://repo.spring.io/release" }
}

dependencyManagement {
    imports {
        mavenBom "org.springframework.cloud:spring-cloud-dependencies:${springCloudVersion}"
        mavenBom "com.netflix.graphql.dgs:graphql-dgs-platform-dependencies:${dgsVersion}"
    }
}

dependencies {
    // Spring Boot Starters
    implementation 'org.springframework.boot:spring-boot-starter-webflux'
    implementation 'org.springframework.boot:spring-boot-starter-security'
    implementation 'org.springframework.boot:spring-boot-starter-validation'

    // R2DBC Dependencies
    implementation 'org.springframework.boot:spring-boot-starter-data-r2dbc'
    implementation 'org.postgresql:r2dbc-postgresql:1.0.4.RELEASE'
    
    // Flyway for database migrations
    implementation 'org.flywaydb:flyway-core'
    implementation 'org.postgresql:postgresql'

    // DGS Framework
    implementation "com.netflix.graphql.dgs:graphql-dgs-spring-boot-starter:${dgsVersion}"
    implementation "com.netflix.graphql.dgs:graphql-dgs-extended-scalars:${dgsVersion}"


    // JWT
    implementation 'io.jsonwebtoken:jjwt-api:0.11.5'
    runtimeOnly 'io.jsonwebtoken:jjwt-impl:0.11.5'
    runtimeOnly 'io.jsonwebtoken:jjwt-jackson:0.11.5'

    // Lombok
    compileOnly 'org.projectlombok:lombok'
    annotationProcessor 'org.projectlombok:lombok'
}

================
File: user-service/Dockerfile
================
# Dockerfile for User Service

# Build stage
FROM gradle:8.5-jdk17 AS build
WORKDIR /app
COPY build.gradle settings.gradle ./
COPY src ./src
COPY gradle ./gradle
COPY gradlew .
RUN chmod +x ./gradlew
RUN ./gradlew build -x test --no-daemon

# Run stage
FROM eclipse-temurin:17-jre-alpine
WORKDIR /app
COPY --from=build /app/build/libs/*.jar app.jar
ENTRYPOINT ["java","-jar","/app/app.jar"]

================
File: user-service/gradle/wrapper/gradle-wrapper.properties
================
distributionBase=GRADLE_USER_HOME
distributionPath=wrapper/dists
distributionUrl=https\://services.gradle.org/distributions/gradle-8.10-bin.zip
networkTimeout=10000
validateDistributionUrl=true
zipStoreBase=GRADLE_USER_HOME
zipStorePath=wrapper/dists

================
File: user-service/gradlew
================
#!/bin/sh

#
# Copyright © 2015-2021 the original authors.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#      https://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
# SPDX-License-Identifier: Apache-2.0
#

##############################################################################
#
#   Gradle start up script for POSIX generated by Gradle.
#
#   Important for running:
#
#   (1) You need a POSIX-compliant shell to run this script. If your /bin/sh is
#       noncompliant, but you have some other compliant shell such as ksh or
#       bash, then to run this script, type that shell name before the whole
#       command line, like:
#
#           ksh Gradle
#
#       Busybox and similar reduced shells will NOT work, because this script
#       requires all of these POSIX shell features:
#         * functions;
#         * expansions «$var», «${var}», «${var:-default}», «${var+SET}»,
#           «${var#prefix}», «${var%suffix}», and «$( cmd )»;
#         * compound commands having a testable exit status, especially «case»;
#         * various built-in commands including «command», «set», and «ulimit».
#
#   Important for patching:
#
#   (2) This script targets any POSIX shell, so it avoids extensions provided
#       by Bash, Ksh, etc; in particular arrays are avoided.
#
#       The "traditional" practice of packing multiple parameters into a
#       space-separated string is a well documented source of bugs and security
#       problems, so this is (mostly) avoided, by progressively accumulating
#       options in "$@", and eventually passing that to Java.
#
#       Where the inherited environment variables (DEFAULT_JVM_OPTS, JAVA_OPTS,
#       and GRADLE_OPTS) rely on word-splitting, this is performed explicitly;
#       see the in-line comments for details.
#
#       There are tweaks for specific operating systems such as AIX, CygWin,
#       Darwin, MinGW, and NonStop.
#
#   (3) This script is generated from the Groovy template
#       https://github.com/gradle/gradle/blob/HEAD/platforms/jvm/plugins-application/src/main/resources/org/gradle/api/internal/plugins/unixStartScript.txt
#       within the Gradle project.
#
#       You can find Gradle at https://github.com/gradle/gradle/.
#
##############################################################################

# Attempt to set APP_HOME

# Resolve links: $0 may be a link
app_path=$0

# Need this for daisy-chained symlinks.
while
    APP_HOME=${app_path%"${app_path##*/}"}  # leaves a trailing /; empty if no leading path
    [ -h "$app_path" ]
do
    ls=$( ls -ld "$app_path" )
    link=${ls#*' -> '}
    case $link in             #(
      /*)   app_path=$link ;; #(
      *)    app_path=$APP_HOME$link ;;
    esac
done

# This is normally unused
# shellcheck disable=SC2034
APP_BASE_NAME=${0##*/}
# Discard cd standard output in case $CDPATH is set (https://github.com/gradle/gradle/issues/25036)
APP_HOME=$( cd -P "${APP_HOME:-./}" > /dev/null && printf '%s
' "$PWD" ) || exit

# Use the maximum available, or set MAX_FD != -1 to use that value.
MAX_FD=maximum

warn () {
    echo "$*"
} >&2

die () {
    echo
    echo "$*"
    echo
    exit 1
} >&2

# OS specific support (must be 'true' or 'false').
cygwin=false
msys=false
darwin=false
nonstop=false
case "$( uname )" in                #(
  CYGWIN* )         cygwin=true  ;; #(
  Darwin* )         darwin=true  ;; #(
  MSYS* | MINGW* )  msys=true    ;; #(
  NONSTOP* )        nonstop=true ;;
esac

CLASSPATH=$APP_HOME/gradle/wrapper/gradle-wrapper.jar


# Determine the Java command to use to start the JVM.
if [ -n "$JAVA_HOME" ] ; then
    if [ -x "$JAVA_HOME/jre/sh/java" ] ; then
        # IBM's JDK on AIX uses strange locations for the executables
        JAVACMD=$JAVA_HOME/jre/sh/java
    else
        JAVACMD=$JAVA_HOME/bin/java
    fi
    if [ ! -x "$JAVACMD" ] ; then
        die "ERROR: JAVA_HOME is set to an invalid directory: $JAVA_HOME

Please set the JAVA_HOME variable in your environment to match the
location of your Java installation."
    fi
else
    JAVACMD=java
    if ! command -v java >/dev/null 2>&1
    then
        die "ERROR: JAVA_HOME is not set and no 'java' command could be found in your PATH.

Please set the JAVA_HOME variable in your environment to match the
location of your Java installation."
    fi
fi

# Increase the maximum file descriptors if we can.
if ! "$cygwin" && ! "$darwin" && ! "$nonstop" ; then
    case $MAX_FD in #(
      max*)
        # In POSIX sh, ulimit -H is undefined. That's why the result is checked to see if it worked.
        # shellcheck disable=SC2039,SC3045
        MAX_FD=$( ulimit -H -n ) ||
            warn "Could not query maximum file descriptor limit"
    esac
    case $MAX_FD in  #(
      '' | soft) :;; #(
      *)
        # In POSIX sh, ulimit -n is undefined. That's why the result is checked to see if it worked.
        # shellcheck disable=SC2039,SC3045
        ulimit -n "$MAX_FD" ||
            warn "Could not set maximum file descriptor limit to $MAX_FD"
    esac
fi

# Collect all arguments for the java command, stacking in reverse order:
#   * args from the command line
#   * the main class name
#   * -classpath
#   * -D...appname settings
#   * --module-path (only if needed)
#   * DEFAULT_JVM_OPTS, JAVA_OPTS, and GRADLE_OPTS environment variables.

# For Cygwin or MSYS, switch paths to Windows format before running java
if "$cygwin" || "$msys" ; then
    APP_HOME=$( cygpath --path --mixed "$APP_HOME" )
    CLASSPATH=$( cygpath --path --mixed "$CLASSPATH" )

    JAVACMD=$( cygpath --unix "$JAVACMD" )

    # Now convert the arguments - kludge to limit ourselves to /bin/sh
    for arg do
        if
            case $arg in                                #(
              -*)   false ;;                            # don't mess with options #(
              /?*)  t=${arg#/} t=/${t%%/*}              # looks like a POSIX filepath
                    [ -e "$t" ] ;;                      #(
              *)    false ;;
            esac
        then
            arg=$( cygpath --path --ignore --mixed "$arg" )
        fi
        # Roll the args list around exactly as many times as the number of
        # args, so each arg winds up back in the position where it started, but
        # possibly modified.
        #
        # NB: a `for` loop captures its iteration list before it begins, so
        # changing the positional parameters here affects neither the number of
        # iterations, nor the values presented in `arg`.
        shift                   # remove old arg
        set -- "$@" "$arg"      # push replacement arg
    done
fi


# Add default JVM options here. You can also use JAVA_OPTS and GRADLE_OPTS to pass JVM options to this script.
DEFAULT_JVM_OPTS='"-Xmx64m" "-Xms64m"'

# Collect all arguments for the java command:
#   * DEFAULT_JVM_OPTS, JAVA_OPTS, JAVA_OPTS, and optsEnvironmentVar are not allowed to contain shell fragments,
#     and any embedded shellness will be escaped.
#   * For example: A user cannot expect ${Hostname} to be expanded, as it is an environment variable and will be
#     treated as '${Hostname}' itself on the command line.

set -- \
        "-Dorg.gradle.appname=$APP_BASE_NAME" \
        -classpath "$CLASSPATH" \
        org.gradle.wrapper.GradleWrapperMain \
        "$@"

# Stop when "xargs" is not available.
if ! command -v xargs >/dev/null 2>&1
then
    die "xargs is not available"
fi

# Use "xargs" to parse quoted args.
#
# With -n1 it outputs one arg per line, with the quotes and backslashes removed.
#
# In Bash we could simply go:
#
#   readarray ARGS < <( xargs -n1 <<<"$var" ) &&
#   set -- "${ARGS[@]}" "$@"
#
# but POSIX shell has neither arrays nor command substitution, so instead we
# post-process each arg (as a line of input to sed) to backslash-escape any
# character that might be a shell metacharacter, then use eval to reverse
# that process (while maintaining the separation between arguments), and wrap
# the whole thing up as a single "set" statement.
#
# This will of course break if any of these variables contains a newline or
# an unmatched quote.
#

eval "set -- $(
        printf '%s\n' "$DEFAULT_JVM_OPTS $JAVA_OPTS $GRADLE_OPTS" |
        xargs -n1 |
        sed ' s~[^-[:alnum:]+,./:=@_]~\\&~g; ' |
        tr '\n' ' '
    )" '"$@"'

exec "$JAVACMD" "$@"

================
File: user-service/gradlew.bat
================
@rem
@rem Copyright 2015 the original author or authors.
@rem
@rem Licensed under the Apache License, Version 2.0 (the "License");
@rem you may not use this file except in compliance with the License.
@rem You may obtain a copy of the License at
@rem
@rem      https://www.apache.org/licenses/LICENSE-2.0
@rem
@rem Unless required by applicable law or agreed to in writing, software
@rem distributed under the License is distributed on an "AS IS" BASIS,
@rem WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
@rem See the License for the specific language governing permissions and
@rem limitations under the License.
@rem
@rem SPDX-License-Identifier: Apache-2.0
@rem

@if "%DEBUG%"=="" @echo off
@rem ##########################################################################
@rem
@rem  Gradle startup script for Windows
@rem
@rem ##########################################################################

@rem Set local scope for the variables with windows NT shell
if "%OS%"=="Windows_NT" setlocal

set DIRNAME=%~dp0
if "%DIRNAME%"=="" set DIRNAME=.
@rem This is normally unused
set APP_BASE_NAME=%~n0
set APP_HOME=%DIRNAME%

@rem Resolve any "." and ".." in APP_HOME to make it shorter.
for %%i in ("%APP_HOME%") do set APP_HOME=%%~fi

@rem Add default JVM options here. You can also use JAVA_OPTS and GRADLE_OPTS to pass JVM options to this script.
set DEFAULT_JVM_OPTS="-Xmx64m" "-Xms64m"

@rem Find java.exe
if defined JAVA_HOME goto findJavaFromJavaHome

set JAVA_EXE=java.exe
%JAVA_EXE% -version >NUL 2>&1
if %ERRORLEVEL% equ 0 goto execute

echo. 1>&2
echo ERROR: JAVA_HOME is not set and no 'java' command could be found in your PATH. 1>&2
echo. 1>&2
echo Please set the JAVA_HOME variable in your environment to match the 1>&2
echo location of your Java installation. 1>&2

goto fail

:findJavaFromJavaHome
set JAVA_HOME=%JAVA_HOME:"=%
set JAVA_EXE=%JAVA_HOME%/bin/java.exe

if exist "%JAVA_EXE%" goto execute

echo. 1>&2
echo ERROR: JAVA_HOME is set to an invalid directory: %JAVA_HOME% 1>&2
echo. 1>&2
echo Please set the JAVA_HOME variable in your environment to match the 1>&2
echo location of your Java installation. 1>&2

goto fail

:execute
@rem Setup the command line

set CLASSPATH=%APP_HOME%\gradle\wrapper\gradle-wrapper.jar


@rem Execute Gradle
"%JAVA_EXE%" %DEFAULT_JVM_OPTS% %JAVA_OPTS% %GRADLE_OPTS% "-Dorg.gradle.appname=%APP_BASE_NAME%" -classpath "%CLASSPATH%" org.gradle.wrapper.GradleWrapperMain %*

:end
@rem End local scope for the variables with windows NT shell
if %ERRORLEVEL% equ 0 goto mainEnd

:fail
rem Set variable GRADLE_EXIT_CONSOLE if you need the _script_ return code instead of
rem the _cmd.exe /c_ return code!
set EXIT_CODE=%ERRORLEVEL%
if %EXIT_CODE% equ 0 set EXIT_CODE=1
if not ""=="%GRADLE_EXIT_CONSOLE%" exit %EXIT_CODE%
exit /b %EXIT_CODE%

:mainEnd
if "%OS%"=="Windows_NT" endlocal

:omega

================
File: user-service/settings.gradle
================
plugins {
    id 'org.gradle.toolchains.foojay-resolver-convention' version '0.5.0' // or latest version
}

rootProject.name = 'user-service'

================
File: user-service/src/main/java/com/glizzy/milliondollarpicks/userservice/config/JwtProperties.java
================
package com.glizzy.milliondollarpicks.userservice.config;
import lombok.Data;
import org.springframework.boot.context.properties.ConfigurationProperties;
import org.springframework.stereotype.Component;
@Data
@Component
@ConfigurationProperties(prefix = "jwt")
public class JwtProperties {
    private String secret;
    private long expiration;
}

================
File: user-service/src/main/java/com/glizzy/milliondollarpicks/userservice/config/PasswordEncoderConfig.java
================
package com.glizzy.milliondollarpicks.userservice.config;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
import org.springframework.security.crypto.password.PasswordEncoder;
@Configuration
public class PasswordEncoderConfig {
    @Bean
    public PasswordEncoder passwordEncoder() {
        return new BCryptPasswordEncoder();
    }
}

================
File: user-service/src/main/java/com/glizzy/milliondollarpicks/userservice/config/R2dbcConfig.java
================
package com.glizzy.milliondollarpicks.userservice.config;
import io.r2dbc.postgresql.PostgresqlConnectionConfiguration;
import io.r2dbc.postgresql.PostgresqlConnectionFactory;
import io.r2dbc.spi.ConnectionFactory;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.data.r2dbc.config.AbstractR2dbcConfiguration;
@Configuration
public class R2dbcConfig extends AbstractR2dbcConfiguration {
    @Value("${spring.r2dbc.host:postgres}")
    private String host;
    @Value("${spring.r2dbc.port}")
    private int port;
    @Value("${spring.r2dbc.database}")
    private String database;
    @Value("${spring.r2dbc.username}")
    private String username;
    @Value("${spring.r2dbc.password}")
    private String password;
    @Override
    @Bean
    public ConnectionFactory connectionFactory() {
        return new PostgresqlConnectionFactory(
            PostgresqlConnectionConfiguration.builder()
                .host(host)
                .port(port)
                .database(database)
                .username(username)
                .password(password)
                .build()
        );
    }
}

================
File: user-service/src/main/java/com/glizzy/milliondollarpicks/userservice/config/SecurityConfig.java
================
package com.glizzy.milliondollarpicks.userservice.config;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.config.annotation.web.reactive.EnableWebFluxSecurity;
import org.springframework.security.config.web.server.ServerHttpSecurity;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.security.web.server.SecurityWebFilterChain;
import org.springframework.boot.autoconfigure.security.servlet.SecurityAutoConfiguration;
import org.springframework.boot.autoconfigure.condition.ConditionalOnWebApplication;
import org.springframework.boot.autoconfigure.condition.ConditionalOnWebApplication.Type;
@Configuration
@EnableWebFluxSecurity
@ConditionalOnWebApplication(type = Type.REACTIVE)
public class SecurityConfig {
    @Bean
    public SecurityWebFilterChain springSecurityFilterChain(ServerHttpSecurity http) {
        return http
                .csrf(ServerHttpSecurity.CsrfSpec::disable)
                .formLogin(ServerHttpSecurity.FormLoginSpec::disable)
                .httpBasic(ServerHttpSecurity.HttpBasicSpec::disable)
                .authorizeExchange(exchanges -> exchanges
                        .pathMatchers("/graphql", "/graphiql", "/graphiql/**", "/vendor/graphiql/**").permitAll()
                        .anyExchange().authenticated()
                )
                .build();
    }
}

================
File: user-service/src/main/java/com/glizzy/milliondollarpicks/userservice/dto/UserDto.java
================
package com.glizzy.milliondollarpicks.userservice.dto;
import com.fasterxml.jackson.annotation.JsonProperty;
import lombok.Data;
import lombok.NoArgsConstructor;
import lombok.AllArgsConstructor;
import lombok.Builder;
import java.time.LocalDateTime;
@Data
@NoArgsConstructor
@AllArgsConstructor
@Builder
public class UserDto {
    private Long id;
    private String username;
    @JsonProperty(access = JsonProperty.Access.WRITE_ONLY)
    private String password;
    private LocalDateTime registrationDate;
    private LocalDateTime lastLoginDate;
    public UserDto(Long id, String username, LocalDateTime registrationDate,
                   LocalDateTime lastLoginDate) {
        this.id = id;
        this.username = username;
        this.registrationDate = registrationDate;
        this.lastLoginDate = lastLoginDate;
    }
}

================
File: user-service/src/main/java/com/glizzy/milliondollarpicks/userservice/entity/User.java
================
package com.glizzy.milliondollarpicks.userservice.entity;
import org.springframework.data.annotation.Id;
import org.springframework.data.relational.core.mapping.Column;
import org.springframework.data.relational.core.mapping.Table;
import lombok.Data;
import lombok.NoArgsConstructor;
import lombok.AllArgsConstructor;
import java.time.LocalDateTime;
@Data
@NoArgsConstructor
@AllArgsConstructor
@Table("users")
public class User {
    @Id
    private Long id;
    @Column("username")
    private String username;
    @Column("password")
    private String password;
    @Column("registration_date")
    private LocalDateTime registrationDate;
    @Column("last_login_date")
    private LocalDateTime lastLoginDate;
}

================
File: user-service/src/main/java/com/glizzy/milliondollarpicks/userservice/exception/DuplicateUserException.java
================
package com.glizzy.milliondollarpicks.userservice.exception;
public class DuplicateUserException extends RuntimeException {
    public DuplicateUserException(String message) {
        super(message);
    }
}

================
File: user-service/src/main/java/com/glizzy/milliondollarpicks/userservice/exception/ErrorResponse.java
================
package com.glizzy.milliondollarpicks.userservice.exception;
import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;
import java.time.LocalDateTime;
@Data
@NoArgsConstructor
@AllArgsConstructor
public class ErrorResponse {
    private LocalDateTime timestamp;
    private int status;
    private String error;
    private String message;
    private String path;
}

================
File: user-service/src/main/java/com/glizzy/milliondollarpicks/userservice/exception/GlobalExceptionHandler.java
================
package com.glizzy.milliondollarpicks.userservice.exception;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.security.access.AccessDeniedException;
import org.springframework.web.bind.annotation.ExceptionHandler;
import org.springframework.web.bind.annotation.RestControllerAdvice;
import org.springframework.web.server.ServerWebExchange;
import reactor.core.publisher.Mono;
import java.time.LocalDateTime;
@RestControllerAdvice
public class GlobalExceptionHandler {
    @ExceptionHandler(UserNotFoundException.class)
    public Mono<ResponseEntity<ErrorResponse>> handleUserNotFoundException(UserNotFoundException ex, ServerWebExchange exchange) {
        return createErrorResponse(ex, HttpStatus.NOT_FOUND, exchange);
    }
    @ExceptionHandler(DuplicateUserException.class)
    public Mono<ResponseEntity<ErrorResponse>> handleDuplicateUserException(DuplicateUserException ex, ServerWebExchange exchange) {
        return createErrorResponse(ex, HttpStatus.CONFLICT, exchange);
    }
    @ExceptionHandler(InvalidCredentialsException.class)
    public Mono<ResponseEntity<ErrorResponse>> handleInvalidCredentialsException(InvalidCredentialsException ex, ServerWebExchange exchange) {
        return createErrorResponse(ex, HttpStatus.UNAUTHORIZED, exchange);
    }
    @ExceptionHandler(JwtAuthenticationException.class)
    public Mono<ResponseEntity<ErrorResponse>> handleJwtAuthenticationException(JwtAuthenticationException ex, ServerWebExchange exchange) {
        return createErrorResponse(ex, HttpStatus.UNAUTHORIZED, exchange);
    }
    @ExceptionHandler(AccessDeniedException.class)
    public Mono<ResponseEntity<ErrorResponse>> handleAccessDeniedException(AccessDeniedException ex, ServerWebExchange exchange) {
        return createErrorResponse(ex, HttpStatus.FORBIDDEN, exchange);
    }
    @ExceptionHandler(Exception.class)
    public Mono<ResponseEntity<ErrorResponse>> handleGlobalException(Exception ex, ServerWebExchange exchange) {
        return createErrorResponse(ex, HttpStatus.INTERNAL_SERVER_ERROR, exchange);
    }
    private Mono<ResponseEntity<ErrorResponse>> createErrorResponse(Exception ex, HttpStatus status, ServerWebExchange exchange) {
        ErrorResponse errorResponse = new ErrorResponse(
            LocalDateTime.now(),
            status.value(),
            status.getReasonPhrase(),
            ex.getMessage(),
            exchange.getRequest().getPath().value()
        );
        return Mono.just(ResponseEntity
            .status(status)
            .body(errorResponse));
    }
}

================
File: user-service/src/main/java/com/glizzy/milliondollarpicks/userservice/exception/InvalidCredentialsException.java
================
package com.glizzy.milliondollarpicks.userservice.exception;
public class InvalidCredentialsException extends RuntimeException {
    public InvalidCredentialsException(String message) {
        super(message);
    }
}

================
File: user-service/src/main/java/com/glizzy/milliondollarpicks/userservice/exception/JwtAuthenticationException.java
================
package com.glizzy.milliondollarpicks.userservice.exception;
public class JwtAuthenticationException extends RuntimeException {
    public JwtAuthenticationException(String message) {
        super(message);
    }
}

================
File: user-service/src/main/java/com/glizzy/milliondollarpicks/userservice/exception/UserNotFoundException.java
================
package com.glizzy.milliondollarpicks.userservice.exception;
public class UserNotFoundException extends RuntimeException {
    public UserNotFoundException(String message) {
        super(message);
    }
}

================
File: user-service/src/main/java/com/glizzy/milliondollarpicks/userservice/graphql/ScalarConfig.java
================
package com.glizzy.milliondollarpicks.userservice.graphql;
import com.netflix.graphql.dgs.DgsComponent;
import com.netflix.graphql.dgs.DgsRuntimeWiring;
import graphql.scalars.ExtendedScalars;
import graphql.schema.idl.RuntimeWiring;
@DgsComponent
public class ScalarConfig {
    @DgsRuntimeWiring
    public RuntimeWiring.Builder addScalar(RuntimeWiring.Builder builder) {
        return builder
                .scalar(ExtendedScalars.DateTime)
                .scalar(ExtendedScalars.Object);
    }
}

================
File: user-service/src/main/java/com/glizzy/milliondollarpicks/userservice/graphql/UserResolver.java
================
package com.glizzy.milliondollarpicks.userservice.graphql;
import com.glizzy.milliondollarpicks.userservice.dto.UserDto;
import com.glizzy.milliondollarpicks.userservice.security.JwtTokenProvider;
import com.glizzy.milliondollarpicks.userservice.service.UserService;
import com.netflix.graphql.dgs.DgsComponent;
import com.netflix.graphql.dgs.DgsQuery;
import com.netflix.graphql.dgs.DgsMutation;
import com.netflix.graphql.dgs.InputArgument;
import com.netflix.graphql.dgs.context.DgsContext;
import graphql.schema.DataFetchingEnvironment;
import lombok.RequiredArgsConstructor;
import org.springframework.http.HttpHeaders;
import org.springframework.security.access.prepost.PreAuthorize;
import reactor.core.publisher.Mono;
@DgsComponent
@RequiredArgsConstructor
public class UserResolver {
    private final UserService userService;
    private final JwtTokenProvider jwtTokenProvider;
    @DgsQuery
    @PreAuthorize("isAuthenticated()")
    public Mono<UserDto> userByUsername(@InputArgument String username) {
        return userService.findUserByUsername(username);
    }
    @DgsQuery
    @PreAuthorize("isAuthenticated()")
    public Mono<UserDto> me(DataFetchingEnvironment dfe) {
        String token = extractToken(dfe);
        if (token != null) {
            String username = jwtTokenProvider.getUsernameFromToken(token);
            return userService.findUserByUsername(username);
        }
        return Mono.empty();
    }
    @DgsMutation
    public Mono<UserDto> registerUser(@InputArgument String username, @InputArgument String password) {
        return userService.registerUser(username, password);
    }
    @DgsMutation
    public Mono<String> login(@InputArgument String username, @InputArgument String password) {
        return userService.login(username, password);
    }
    @DgsMutation
    @PreAuthorize("isAuthenticated()")
    public Mono<Boolean> logout(DataFetchingEnvironment dfe) {
        String token = extractToken(dfe);
        return userService.logout(token);
    }
    private String extractToken(DataFetchingEnvironment dfe) {
        HttpHeaders headers = dfe.getGraphQlContext().get("headers");
        if (headers != null) {
            String authHeader = headers.getFirst(HttpHeaders.AUTHORIZATION);
            if (authHeader != null && authHeader.startsWith("Bearer ")) {
                return authHeader.substring(7);
            }
        }
        return null;
    }
}

================
File: user-service/src/main/java/com/glizzy/milliondollarpicks/userservice/mapper/UserMapper.java
================
package com.glizzy.milliondollarpicks.userservice.mapper;
import com.glizzy.milliondollarpicks.userservice.dto.UserDto;
import com.glizzy.milliondollarpicks.userservice.entity.User;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.stereotype.Component;
@Component
public class UserMapper {
    private final PasswordEncoder passwordEncoder;
    public UserMapper(PasswordEncoder passwordEncoder) {
        this.passwordEncoder = passwordEncoder;
    }
    public UserDto toDto(User user) {
        if (user == null) {
            return null;
        }
        return UserDto.builder()
                .id(user.getId())
                .username(user.getUsername())
                .registrationDate(user.getRegistrationDate())
                .lastLoginDate(user.getLastLoginDate())
                .build();
    }
    public User toEntity(UserDto userDto) {
        if (userDto == null) {
            return null;
        }
        User user = new User();
        user.setId(userDto.getId());
        user.setUsername(userDto.getUsername());
        user.setRegistrationDate(userDto.getRegistrationDate());
        user.setLastLoginDate(userDto.getLastLoginDate());
        return user;
    }
    public User toRegistrationEntity(UserDto userDto) {
        if (userDto == null) {
            return null;
        }
        User user = new User();
        user.setUsername(userDto.getUsername());
        if (userDto.getPassword() != null) {
            user.setPassword(passwordEncoder.encode(userDto.getPassword()));
        }
        return user;
    }
    public UserDto toRegistrationDto(User user) {
        return toDto(user);
    }
    public void updateEntityFromDto(UserDto userDto, User user) {
        if (userDto == null || user == null) {
            return;
        }
        if (userDto.getUsername() != null) {
            user.setUsername(userDto.getUsername());
        }
        if (userDto.getPassword() != null && !userDto.getPassword().isEmpty()) {
            user.setPassword(passwordEncoder.encode(userDto.getPassword()));
        }
    }
}

================
File: user-service/src/main/java/com/glizzy/milliondollarpicks/userservice/repository/UserRepository.java
================
package com.glizzy.milliondollarpicks.userservice.repository;
import com.glizzy.milliondollarpicks.userservice.entity.User;
import org.springframework.data.r2dbc.repository.Modifying;
import org.springframework.data.r2dbc.repository.Query;
import org.springframework.data.r2dbc.repository.R2dbcRepository;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;
import reactor.core.publisher.Mono;
import java.time.LocalDateTime;
@Repository
public interface UserRepository extends R2dbcRepository<User, Long> {
    Mono<User> findByUsername(String username);
    Mono<Boolean> existsByUsername(String username);
}

================
File: user-service/src/main/java/com/glizzy/milliondollarpicks/userservice/security/AuthenticationManager.java
================
package com.glizzy.milliondollarpicks.userservice.security;
import lombok.RequiredArgsConstructor;
import org.springframework.security.authentication.ReactiveAuthenticationManager;
import org.springframework.security.core.Authentication;
import org.springframework.stereotype.Component;
import reactor.core.publisher.Mono;
@Component
@RequiredArgsConstructor
public class AuthenticationManager implements ReactiveAuthenticationManager {
    private final JwtTokenProvider tokenProvider;
    @Override
    public Mono<Authentication> authenticate(Authentication authentication) {
        String authToken = authentication.getCredentials().toString();
        try {
            if (!tokenProvider.validateToken(authToken)) {
                return Mono.empty();
            }
            return Mono.just(tokenProvider.getAuthentication(authToken));
        } catch (Exception e) {
            return Mono.empty();
        }
    }
}

================
File: user-service/src/main/java/com/glizzy/milliondollarpicks/userservice/security/JwtAuthenticationFilter.java
================
package com.glizzy.milliondollarpicks.userservice.security;
import lombok.RequiredArgsConstructor;
import org.springframework.http.HttpHeaders;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.context.ReactiveSecurityContextHolder;
import org.springframework.stereotype.Component;
import org.springframework.util.StringUtils;
import org.springframework.web.server.ServerWebExchange;
import org.springframework.web.server.WebFilter;
import org.springframework.web.server.WebFilterChain;
import reactor.core.publisher.Mono;
@Component
@RequiredArgsConstructor
public class JwtAuthenticationFilter implements WebFilter {
    private final JwtTokenProvider tokenProvider;
    @Override
    public Mono<Void> filter(ServerWebExchange exchange, WebFilterChain chain) {
        String token = resolveToken(exchange);
        if (StringUtils.hasText(token) && tokenProvider.validateToken(token)) {
            Authentication authentication = tokenProvider.getAuthentication(token);
            return chain.filter(exchange)
                    .contextWrite(ReactiveSecurityContextHolder.withAuthentication(authentication));
        }
        return chain.filter(exchange);
    }
    private String resolveToken(ServerWebExchange exchange) {
        String bearerToken = exchange.getRequest().getHeaders().getFirst(HttpHeaders.AUTHORIZATION);
        if (StringUtils.hasText(bearerToken) && bearerToken.startsWith("Bearer ")) {
            return bearerToken.substring(7);
        }
        return null;
    }
}

================
File: user-service/src/main/java/com/glizzy/milliondollarpicks/userservice/security/JwtTokenProvider.java
================
package com.glizzy.milliondollarpicks.userservice.security;
import com.glizzy.milliondollarpicks.userservice.config.JwtProperties;
import io.jsonwebtoken.Claims;
import io.jsonwebtoken.Jwts;
import io.jsonwebtoken.security.Keys;
import lombok.RequiredArgsConstructor;
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.GrantedAuthority;
import org.springframework.security.core.authority.SimpleGrantedAuthority;
import org.springframework.stereotype.Component;
import javax.crypto.SecretKey;
import java.nio.charset.StandardCharsets;
import java.util.Arrays;
import java.util.Collection;
import java.util.Date;
import java.util.stream.Collectors;
@Component
@RequiredArgsConstructor
public class JwtTokenProvider {
    private final JwtProperties jwtProperties;
    public String generateToken(Authentication authentication) {
        String authorities = authentication.getAuthorities().stream()
                .map(GrantedAuthority::getAuthority)
                .collect(Collectors.joining(","));
        Date now = new Date();
        Date expiryDate = new Date(now.getTime() + jwtProperties.getExpiration());
        return Jwts.builder()
                .setSubject(authentication.getName())
                .setIssuedAt(now)
                .setExpiration(expiryDate)
                .claim("roles", authorities)
                .signWith(getSigningKey())
                .compact();
    }
    public Authentication getAuthentication(String token) {
        Claims claims = Jwts.parserBuilder()
                .setSigningKey(getSigningKey())
                .build()
                .parseClaimsJws(token)
                .getBody();
        Collection<? extends GrantedAuthority> authorities = Arrays.stream(claims.get("roles").toString().split(","))
                .filter(auth -> !auth.trim().isEmpty())
                .map(SimpleGrantedAuthority::new)
                .collect(Collectors.toList());
        return new UsernamePasswordAuthenticationToken(claims.getSubject(), "", authorities);
    }
    public boolean validateToken(String token) {
        try {
            Jwts.parserBuilder()
                    .setSigningKey(getSigningKey())
                    .build()
                    .parseClaimsJws(token);
            return true;
        } catch (Exception e) {
            return false;
        }
    }
    public String getUsernameFromToken(String token) {
        Claims claims = Jwts.parserBuilder()
                .setSigningKey(getSigningKey())
                .build()
                .parseClaimsJws(token)
                .getBody();
        return claims.getSubject();
    }
    private SecretKey getSigningKey() {
        byte[] keyBytes = jwtProperties.getSecret().getBytes(StandardCharsets.UTF_8);
        return Keys.hmacShaKeyFor(keyBytes);
    }
}

================
File: user-service/src/main/java/com/glizzy/milliondollarpicks/userservice/service/UserService.java
================
package com.glizzy.milliondollarpicks.userservice.service;
import com.glizzy.milliondollarpicks.userservice.dto.*;
import reactor.core.publisher.Mono;
public interface UserService {
    Mono<UserDto> findUserByUsername(String username);
    Mono<UserDto> registerUser(String username, String password);
    Mono<String> login(String username, String password);
    Mono<Boolean> logout(String token);
}

================
File: user-service/src/main/java/com/glizzy/milliondollarpicks/userservice/service/UserServiceImpl.java
================
package com.glizzy.milliondollarpicks.userservice.service;
import com.glizzy.milliondollarpicks.userservice.dto.UserDto;
import com.glizzy.milliondollarpicks.userservice.entity.User;
import com.glizzy.milliondollarpicks.userservice.mapper.UserMapper;
import com.glizzy.milliondollarpicks.userservice.exception.DuplicateUserException;
import com.glizzy.milliondollarpicks.userservice.exception.InvalidCredentialsException;
import com.glizzy.milliondollarpicks.userservice.exception.UserNotFoundException;
import com.glizzy.milliondollarpicks.userservice.repository.UserRepository;
import com.glizzy.milliondollarpicks.userservice.security.JwtTokenProvider;
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.authority.SimpleGrantedAuthority;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.stereotype.Service;
import reactor.core.publisher.Mono;
import java.time.LocalDateTime;
import java.util.Collections;
import java.util.HashSet;
import java.util.Set;
import lombok.RequiredArgsConstructor;
@Service
@RequiredArgsConstructor
public class UserServiceImpl implements UserService {
    private final UserRepository userRepository;
    private final UserMapper userMapper;
    private final PasswordEncoder passwordEncoder;
    private final JwtTokenProvider tokenProvider;
    private final Set<String> invalidatedTokens = new HashSet<>();
    @Override
    public Mono<UserDto> findUserByUsername(String username) {
        return userRepository.findByUsername(username)
                .switchIfEmpty(Mono.error(new UserNotFoundException("User not found with username: " + username)))
                .map(userMapper::toDto);
    }
    @Override
    public Mono<UserDto> registerUser(String username, String password) {
        return userRepository.existsByUsername(username)
                .flatMap(exists -> {
                    if (Boolean.TRUE.equals(exists)) {
                        return Mono.error(new DuplicateUserException("Username already exists: " + username));
                    }
                    UserDto userDto = new UserDto();
                    userDto.setUsername(username);
                    userDto.setPassword(password);
                    User newUser = userMapper.toRegistrationEntity(userDto);
                    newUser.setRegistrationDate(LocalDateTime.now());
                    return userRepository.save(newUser)
                            .map(userMapper::toRegistrationDto);
                });
    }
    @Override
    public Mono<String> login(String username, String password) {
        return userRepository.findByUsername(username)
                .switchIfEmpty(Mono.error(new InvalidCredentialsException("Invalid username or password")))
                .flatMap(user -> {
                    if (!passwordEncoder.matches(password, user.getPassword())) {
                        return Mono.error(new InvalidCredentialsException("Invalid username or password"));
                    }
                    user.setLastLoginDate(LocalDateTime.now());
                    return userRepository.save(user)
                            .then(generateToken(user.getUsername()));
                });
    }
    @Override
    public Mono<Boolean> logout(String token) {
        if (token != null && tokenProvider.validateToken(token)) {
            invalidatedTokens.add(token);
            return Mono.just(true);
        }
        return Mono.just(false);
    }
    private Mono<String> generateToken(String username) {
        Authentication authentication = new UsernamePasswordAuthenticationToken(
                username,
                null,
                Collections.singletonList(new SimpleGrantedAuthority("ROLE_USER"))
        );
        return Mono.just(tokenProvider.generateToken(authentication));
    }
}

================
File: user-service/src/main/java/com/glizzy/milliondollarpicks/userservice/UserServiceApplication.java
================
package com.glizzy.milliondollarpicks.userservice;
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.boot.context.properties.EnableConfigurationProperties;
@SpringBootApplication
@EnableConfigurationProperties
public class UserServiceApplication {
    public static void main(String[] args) {
        SpringApplication.run(UserServiceApplication.class, args);
    }
}

================
File: user-service/src/main/resources/application-docker.yml
================
spring:
  r2dbc:
    url: ${SPRING_R2DBC_URL:r2dbc:postgresql://postgres:5432/userdb}
    username: ${SPRING_R2DBC_USERNAME:postgres}
    password: ${SPRING_R2DBC_PASSWORD:postgres}
  flyway:
    url: ${SPRING_FLYWAY_URL:jdbc:postgresql://postgres:5432/userdb}
    user: ${SPRING_FLYWAY_USER:postgres}
    password: ${SPRING_FLYWAY_PASSWORD:postgres}

================
File: user-service/src/main/resources/application.yml
================
spring:
  r2dbc:
    host: ${DB_HOST:localhost}
    port: ${DB_PORT:5432}
    database: ${DB_NAME:userdb}
    username: ${DB_USERNAME:postgres}
    password: ${DB_PASSWORD:postgres}
  flyway:
    url: jdbc:postgresql://${spring.r2dbc.host}:${spring.r2dbc.port}/${spring.r2dbc.database}
    user: ${spring.r2dbc.username}
    password: ${spring.r2dbc.password}
    baseline-on-migrate: true
    locations: classpath:db/migration
dgs:
  graphql:
    enabled: true
  graphiql:
    enabled: true
logging:
  level:
    org.springframework.beans.factory.support: DEBUG
    com.netflix.graphql.dgs: DEBUG

================
File: user-service/src/main/resources/db/migration/V1__init_user_schema.sql
================
CREATE TABLE IF NOT EXISTS users (
     id SERIAL PRIMARY KEY,
     username VARCHAR(50) NOT NULL UNIQUE,
     password VARCHAR(255) NOT NULL,
     registration_date TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
     last_login_date TIMESTAMP
);

================
File: user-service/src/main/resources/schema/schema.graphqls
================
type Query {
    me: User
    userById(id: ID!): User
    userByUsername(username: String!): User
}

type Mutation {
    registerUser(username: String!, password: String!): User
    login(username: String!, password: String!): String
    logout: Boolean
}

type User {
    id: ID!
    username: String!
    registrationDate: String!
    lastLoginDate: String
}


================================================================
Instruction
================================================================
{
    "output": {
        "instructionFilePath": "repomix-instruction.md",
        "removeComments": true
    }
}
